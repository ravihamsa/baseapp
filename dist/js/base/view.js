define(["base/app","base/model","base/util"],function(e,t,n){var r=Backbone.View.extend({constructor:function(e){var t=this;t.removeQue=[],t.removed=!1,t.rendered=!1,Backbone.View.call(t,e),_.each(m,function(e){e(t)})},postSetup:function(){},postMetaLoad:function(){},render:function(){var n=this;n.$el.addClass("rendering");var r=(new Date).getTime();n.beforeRender();var i=function(){n.removeChildViews&&n.removeChildViews(),e.getTemplateDef(n.getTemplate()).done(v(n,function(e){n.model||(n.model=new t),n.renderTemplate(e),u(n);if(n.setState){var i=_.keys(n.getOption("states"))[0];n.setState(n.getState()||n.getOption("state")||i)}n.postRender(),n.$el.removeClass("rendering");var s=(new Date).getTime()-r;s>20&&console.warn(this.$el[0],s),n.rendered=!0}))},s=function(){n.postMetaLoad.apply(n,arguments),i()};if(!n.rendered){var o=n.loadMeta();o.done(v(n,s))}else i();return n},postRender:function(){},beforeRender:function(){},renderTemplate:function(e){var t=this.getOption("useDeepJSON");this.$el.html(e(this.model.toJSON(t)))},getOption:function(e){return this.options[e]||this[e]},loadingHandler:function(e){this.$el.toggleClass("loading",e)},metaLoadErrorHandler:function(){this.$el.html("Error Loading Meta Data")},addMethod:function(e,t){this[e]||(this[e]=t)},remove:function(){this.removeChildViews(),Backbone.View.prototype.remove.call(this),this.removeReferences(),this.stopListening(),this.removeQue=null,this.removed=!0},removeReferences:function(e){e?this.removeQue.push(e):_.each(this.removeQue,function(e){e.call(this)})}});r.deepExtendMethods=function(e){var t=this.prototype;_.each(e,function(e,n){var r=t[n];if(!r)throw new Error("Method with name: "+n+" doesn't exists to deep extend");t[n]=function(){r.apply(this,arguments),e.apply(this,arguments)}})};var i=function(e){var t=e.model||e.collection,n;n=e.dataEvents,_.each(n,function(n,r){var i,s,o;o=/\s+/,s=n.split(o),i=r.split(o),_.each(s,function(n){_.each(i,function(r){e.listenTo(t,r,function(){if(!e[n])throw n+" Not Defined";var t=Array.prototype.slice.call(arguments);t.unshift(r),e[n].apply(e,t)})})})})},s=function(e){var t=e.getOption("states");if(!t)return;var r,i,s=function(){i&&i.remove()},o=function(t){i=n.createView({View:t,model:e.model,parentEl:e.$(".state-view"),parentView:e}),e.listenTo(i,"setState",function(t){e.setState(t)})};e.setState=function(e){if(typeof e!="string")throw new Error("state should be a string");if(r===e)return;r=e;var n=t[e];if(!n)throw new Error("Invalid State");s(),o(n)},e.getState=function(){return r},e.removeReferences(function(){t=null,r=null,i=null,e=null})},o=function(e){var t=e.getOption("template")||e.template;e.setTemplate=function(n){t=n,e.render()},e.getTemplate=function(){return t},e.removeReferences(function(){t=null,e=null})},u=function(e){var t={},r=e.getOption("views");e.getSubView=function(e){var n=t[e];if(n)return n;console.log("No View Defined for id :"+e)},e.setSubView=function(e,n){t[e]=n},e.getAllSubViews=function(){return t},e.getSubCollection=function(t){return e.getSubView(t).collection},e.getSubModel=function(t){return e.getSubView(t).model},e.getSubAttribute=function(t,n){return e.getSubModel(t).get(n)},e.removeReferences(function(){r=null,t=null,e=null}),_.each(r,function(t,r){t.parentView=e;var i=n.createView(t);e.setSubView(r,i)})},a=function(e){var t=e.model;t&&(e.listenTo(t,"change",_.bind(f,e)),l.call(e,t))},f=function(e){var t=e.changedAttributes();_.each(t,function(e,t){var n=this[t+"ChangeHandler"];n&&typeof n=="function"&&n.call(this,e)},this);var n=this.changeHandler;n&&typeof n=="function"&&n.call(this,t)},l=function(e){var t=e.toJSON();_.each(t,function(e,t){var n=this[t+"ChangeHandler"];n&&typeof n=="function"&&n.call(this,e)},this);var n=this.changeHandler;n&&typeof n=="function"&&n.call(this,t)},c=function(e){var t=function(e){e.actionHandled&&(e.stopPropagation(),$("body").trigger("click"))};e.actionHandler&&e.$el.on("click",".action",function(n){n.preventDefault();var r=$(n.currentTarget),i=r.attr("href").substr(1);e.actionHandler.call(e,i,n),t(n)}),e.$el.on("click",".dummy",function(e){e.preventDefault()}),e.removeReferences(function(){e.$el.off(),e=null})},h=function(e){var t=e.getOption("renderEvents")||e.renderEvents;t&&t.length>0&&e.listenTo(e.model,t.join(" "),function(){e.render.call(e)})},p=function(t){var n=t.getOption("requests")||t.requests,r=0,i=v(t,function(){r++,r>0&&t.loadingHandler.call(t,!0)}),s=v(t,function(){r--,r<1&&t.loadingHandler.call(t,!1)});t.addRequest=function(t,n){var r=t;_.isArray(r)||(r=[r]);var o=_.map(r,function(t){var n=e.getRequestDef(t);return t.callback&&n.always(t.callback),i(),n.always(s),n}),u=$.when.apply(null,o);return n&&u.then(n),u},t.loadMeta=function(){if(!t.metaDef){var e=n?t.addRequest(n,v(t,function(e){t.metaCache=e})):$.when({});t.metaDef=e}return t.metaDef},t.removeReferences(function(){n=null,r=null,t=null})},d=function(e){var t=[];e.addChildView=function(e){t.push(e)},e.removeChildViews=function(){_.each(t,function(e){e&&e.remove&&e.remove()}),t=[]},e.removeReferences(function(){t=null,e=null})},v=function(e,t){return function(){e.removed||t.apply(e,arguments)}},m=[i,p,o,a,c,h,s,d];return r});