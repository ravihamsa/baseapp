define(["base/app","base","widgets/form/element","widgets/messageStack","text!./form/checkListView.html","text!./form/checkBoxView.html","text!./form/radioListView.html","text!./form/selectView.html","text!./form/textAreaView.html","text!./form/buttonView.html"],function(e,t,n,r,i,s,o,u,a,f){var l=n.View,c=n.Model,h=n.Collection,p=l.extend({template:f,valueFunction:function(){return},valueChangeHandler:function(e){return}}),d=l.extend({template:s,valueFunction:function(){return this.$("input").is(":checked")},valueChangeHandler:function(e){this.$("input").attr("checked",e)}}),v=l.extend({template:a,events:{"change textarea":"updateValue","blur textarea":"updateValue"},valueFunction:function(){return this.$("textarea").val()},valueChangeHandler:function(e){this.$("textarea").val(e)}}),m=l.extend({template:u,events:{"change select":"updateValue","blur select":function(){this.updateValue(),this.removeFocus()},click:"setFocus"},valueFunction:function(){return this.$("select").val()},valueChangeHandler:function(e){this.$("select").val(e)},disabledChangeHandler:function(e){this.$el.toggleClass("disabled",e),this.$("select").attr("disabled",e)}}),g=l.extend({template:o,valueFunction:function(){return this.$("input:checked").val()},valueChangeHandler:function(e){this.$("input[value="+e+"]").attr("checked",!0)}}),y=l.extend({template:i,valueFunction:function(){var e=this.$("input:checked"),t=_.map(e,function(e){return $(e).val()});return t},valueChangeHandler:function(e){_.isArray(e)&&_.each(e,function(e){this.$("input[value="+e+"]").attr("checked",!0)},this)}}),b=l.extend({template:'<input type="hidden" value="{{value}}" name="{{name}}" />',valueChangeHandler:function(e){this.$("input").val(e),this.$("input").trigger("change")},valueFunction:function(){return""+this.$("input").val()}}),w=l.extend({template:" ",valueChangeHandler:function(e){},valueFunction:function(){}}),E=l.extend({template:'<input type="hidden" value="{{value}}" name="{{name}}" />',valueChangeHandler:function(e){this.$("input").val(JSON.stringify(e)),this.updateValue()},valueFunction:function(){return JSON.parse(this.$("input").val())}}),S=l.extend({valueFunction:function(){return this.$("input").is(":checked")},valueChangeHandler:function(e){this.$("input").attr("checked",e)}}),x={select:m,textarea:v,checkbox:d,radioList:g,checkList:y,hidden:b,json:E,submit:p,container:w},T=function(e){return x[e]||l},N=function(e,t){x[e]=t},C=function(e){x=_.extend({},x,e)},k=t.Model.extend({constructor:function(){t.Model.apply(this,arguments)},defaults:{elements:new h},setElementAttribute:function(e,t,n){var r=this.get("elements");r.get(e).set(t,n)},getValueObject:function(){var e=this.get("elements"),t=this.validateElements(),n={};return t.length===0&&e.each(function(e){e.is("active")&&(n[e.id]=e.get("value"))}),n},validateElements:function(){var e=this.get("elements"),t=[];return e.each(function(e){t=t.concat(e.isElementValid())}),t},elementsChangeHandler:function(){var e=this.get("elements");e.on("change",function(e){var t="change",n=Array.prototype.slice.call(arguments,[0]);n[0]="elements:"+t,this.trigger.apply(this,n),n[0]="elements:"+e.get("name")+":"+t,this.trigger.apply(this,n)},this)}}),L="grp-",A=t.View.extend({constructor:function(e){this.typeViewIndex={},t.View.apply(this,arguments)},tagName:"div",className:"form-view",events:{"submit form":"formSubmitHandler"},template:'<div class="form-message-container"></div><form action="{{actionId}}" class="form-vertical" method=""> <div class="group-list"></div> <div class="grp-buttons"> </div> </form>',postRender:function(){this.formEl=this.$("form"),this.renderGroupContainers(),this.renderMessageStack();var e=this.model,t=e.get("elements");t.each(function(e){this.addElement(e)},this)},addElement:function(e){var t=e.toJSON(),n=this.typeViewIndex[t.type]||T(t.type),r=t.name,i,s=this.$(".element-"+r);if(s.length!==0)i=new n({model:e,el:s}),i.postRender(),i.syncAttributes();else{i=new n({model:e});var o=t.group;this.$("."+L+o).append(i.render().el)}},renderGroupContainers:function(){var e=this.model,t=e.get("elements"),n=_.unique(t.pluck("group")),r=this.$(".group-list");_.each(n,function(e){this.$("."+L+e).length===0&&r.append('<div class="'+L+e+'"></div>')},this)},renderMessageStack:function(){var e=new r.Model,t=new r.View({model:e,el:this.$(".form-message-container")});t.render(),this.on("showMessages",function(t){e.removeAllMessages(),_.each(t,function(t){var n=new r.Model(t);e.addMessage(n.toJSON())})}),this.on("clearMessages",function(t){e.removeAllMessages()})},formSubmitHandler:function(e){e.preventDefault(),this.trigger("clearMessages");var t=this.model.getValueObject(),n=this.model.get("actionId");this.options.prePostParser&&(t=this.options.prePostParser(t)),this.trigger("formSubmit",t)},addToTypeViewIndex:function(e,t){this.typeViewIndex[e]=t},submitSuccessHandler:function(){console.log(arguments)},submitFailureHandler:function(e,t){_.each(t,function(e){e.messageType="failure",e.expires=0}),this.trigger("showMessages",t)},setElementValue:function(e,t){var n=this.model.get("elements");n.get(e).set("value",t)}});return A.addToTypeViewIndex=function(e,t){N(e,t)},{Model:k,View:A,ElementModel:c,ElementCollection:h,ElementView:l}});