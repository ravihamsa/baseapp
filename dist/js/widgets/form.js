define(["base/app","base","widgets/form/element","widgets/messageStack","text!./form/checkListView.html","text!./form/radioListView.html","text!./form/selectView.html","text!./form/textAreaView.html","text!./form/buttonView.html"],function(e,t,n,r,i,s,o,u,a){var f=n.View,l=n.Model,c=n.Collection,h=f.extend({template:a,valueFunction:function(){return},valueChangeHandler:function(e){return}}),p=f.extend({valueFunction:function(){return this.$("input").is(":checked")},valueChangeHandler:function(e){this.$("input").attr("checked",e)}}),d=f.extend({template:u,events:{"change textarea":"updateValue","blur textarea":"updateValue"},valueFunction:function(){return this.$("textarea").val()},valueChangeHandler:function(e){this.$("textarea").val(e)}}),v=f.extend({template:o,events:{"change select":"updateValue","blur select":function(){this.updateValue(),this.removeFocus()},click:"setFocus"},valueFunction:function(){return this.$("select").val()},valueChangeHandler:function(e){this.$("select").val(e)},disabledChangeHandler:function(e){this.$el.toggleClass("disabled",e),this.$("select").attr("disabled",e)}}),m=f.extend({template:s,valueFunction:function(){return this.$("input:checked").val()},valueChangeHandler:function(e){this.$("input[value="+e+"]").attr("checked",!0)}}),g=f.extend({template:i,valueFunction:function(){var e=this.$("input:checked"),t=_.map(e,function(e){return $(e).val()});return t},valueChangeHandler:function(e){_.isArray(e)&&_.each(e,function(e){this.$("input[value="+e+"]").attr("checked",!0)},this)}}),y=f.extend({template:'<input type="hidden" value="{{value}}" name="{{name}}" />',valueChangeHandler:function(e){this.$("input").val(e),this.$("input").trigger("change")},valueFunction:function(){return""+this.$("input").val()}}),b=f.extend({template:" ",valueChangeHandler:function(e){},valueFunction:function(){}}),w=f.extend({template:'<input type="hidden" value="{{value}}" name="{{name}}" />',valueChangeHandler:function(e){this.$("input").val(JSON.stringify(e)),this.updateValue()},valueFunction:function(){return JSON.parse(this.$("input").val())}}),E=f.extend({valueFunction:function(){return this.$("input").is(":checked")},valueChangeHandler:function(e){this.$("input").attr("checked",e)}}),S={select:v,textarea:d,checkbox:p,radioList:m,checkList:g,hidden:y,json:w,submit:h,container:b},x=function(e){return S[e]||f},T=function(e){S=_.extend({},S,e)},N=t.Model.extend({constructor:function(){t.Model.apply(this,arguments);var e=this.get("elements");e.on("change",function(e){var t="change",n=Array.prototype.slice.call(arguments,[0]);n[0]="elements:"+t,this.trigger.apply(this,n),n[0]="elements:"+e.get("name")+":"+t,this.trigger.apply(this,n)},this),e.each(function(t){var n=t.get("activeRules");_.each(n,function(n){var r=e.get(n.element);r.on("change:value",function(e,n){t.updateActive()}),t.updateActive()})})},defaults:{elements:new c},setElementAttribute:function(e,t,n){var r=this.get("elements");r.get(e).set(t,n)},getValueObject:function(){var e=this.get("elements"),t=this.validateElements(),n={};return t.length===0&&e.each(function(e){e.is("active")&&(n[e.id]=e.get("value"))}),n},validateElements:function(){var e=this.get("elements"),t=[];return e.each(function(e){t=t.concat(e.isElementValid())}),t}}),C="grp-",k=t.View.extend({constructor:function(e){this.typeViewIndex={},t.View.apply(this,arguments)},tagName:"div",className:"form-view",events:{"submit form":"formSubmitHandler"},template:'<div class="form-message-container"></div><form action="{{actionId}}" class="form-vertical" method=""> <div class="group-list"></div> <div class="grp-buttons"> </div> </form>',postRender:function(){this.formEl=this.$("form"),this.renderGroupContainers(),this.renderMessageStack();var e=this.model,t=e.get("elements");t.each(function(e){this.addElement(e)},this)},addElement:function(e){var t=e.toJSON(),n=this.typeViewIndex[t.type]||x(t.type),r=t.name,i,s=this.$(".element-"+r);if(s.length!==0)i=new n({model:e,el:s}),i.afterRender(),i.syncAttributes();else{i=new n({model:e});var o=t.group;this.$("."+C+o).append(i.render().el)}},renderGroupContainers:function(){var e=this.model,t=e.get("elements"),n=_.unique(t.pluck("group")),r=this.$(".group-list");_.each(n,function(e){this.$("."+C+e).length===0&&r.append('<div class="'+C+e+'"></div>')},this)},renderMessageStack:function(){var e=new r.Model,t=new r.View({model:e,el:this.$(".form-message-container")});t.render(),this.on("showMessages",function(t){e.removeAllMessages(),_.each(t,function(t){var n=new r.Model(t);e.addMessage(n.toJSON())})}),this.on("clearMessages",function(t){e.removeAllMessages()})},formSubmitHandler:function(e){e.preventDefault(),this.trigger("clearMessages");var t=this.model.getValueObject(),n=this.model.get("actionId");this.options.prePostParser&&(t=this.options.prePostParser(t)),this.trigger("formSubmit",t)},addToTypeViewIndex:function(e,t){this.typeViewIndex[e]=t},submitSuccessHandler:function(){console.log(arguments)},submitFailureHandler:function(e,t){_.each(t,function(e){e.messageType="failure",e.expires=0}),this.trigger("showMessages",t)},setElementValue:function(e,t){var n=this.model.get("elements");n.get(e).set("value",t)}});return{Model:N,View:k,ElementModel:l,ElementCollection:c,ElementView:f}});