define(["base/app","base/view","base/model","base/configurableModel","base/collection","base/util","widgets/table/rowCollection","widgets/table/pagination"],function(e,t,n,r,i,s,o,u){var a=n.extend({}),f=t.extend({constructor:function(){var e=this;t.apply(e,arguments);var n=e.getOption("rowModel");if(!n)return;var r=e.model.get("key");e.listenTo(n,"change:"+r,function(t,n){e.model.set("value",n)})},tagName:"td",template:'<div class="cell-value" style="text-align: {{align}};">{{#if renderHTML}}{{{value}}}{{else}}{{value}}{{/if}}</div>',attributes:function(){var e=this.model.toJSON();return{"class":e.classNames,style:"width:"+e.width,"data-key":e.key}},valueChangeHandler:function(){this.render()},valueFunction:function(){return _this.model.get("value")}}),l=f.extend({tagName:"th",template:'<div class="cell-value" style="text-align: {{align}};">{{#if renderHTML}}{{{label}}}{{else}}{{label}}{{/if}}</div>'}),c=l.extend({constructor:function(){var e=this;t.apply(e,arguments);var n=e.getOption("rowCollection"),r=e.model.get("key"),i=function(){var t=n.getProcessedRecords(),i=_.filter(t,function(e){return e.get(r)===!0});i.length===t.length?e.model.set("value",!0):e.model.set("value",!1)};e.listenTo(n,"change:"+r,i),i()},template:'<label class="cell-value" style="text-align: {{align}}; display:block;"> <input type="checkbox" /></label>',events:{"change input":"updateRowCollection"},updateRowCollection:function(){var e=this.model.get("key"),t=this.getOption("rowCollection"),n=t.getProcessedRecords(),r=this.valueFunction();_.each(n,function(t){t.set(e,r)})},valueFunction:function(){return this.$("input").is(":checked")},valueChangeHandler:function(e){this.$("input").prop("checked",e)}}),h=f.extend({template:'<label class="cell-value" style="text-align: {{align}}; display:block;"> <input type="checkbox" /></label>',events:{"change input":"updateRowModel"},updateRowModel:function(){var e=this.getOption("rowModel"),t=this.model.get("key");e.set(t,this.valueFunction())},valueFunction:function(){return this.$("input").is(":checked")},valueChangeHandler:function(e){this.$("input").prop("checked",e)}}),p={checkbox:h},d={checkbox:c},v=t.extend({tagName:"tr",className:"table-row",postRender:function(){var e=this,t=this.model.toJSON(!0),r=t.items,i=this.getOption("rowModel");_.each(r,function(t){var r=p[t.type]||f,o=s.createView({View:r,Model:n,modelAttributes:t,rowModel:i,parentView:e});o.$el.appendTo(e.$el)})},useDeepJSON:!0}),m=v.extend({className:"table-heading",postRender:function(){var e=this,t=this.model.toJSON(!0),r=t.items,i=this.getOption("rowCollection");_.each(r,function(t){var r=d[t.type]||l,o=s.createView({View:r,Model:n,modelAttributes:t,rowCollection:i,parentView:e});o.$el.appendTo(e.$el)})}}),g=function(){var t=this,r={},o=this.$el,u=this.getOption("rowCollection"),a=this.getOption("columns");t.addItem=function(o,f,l){var c=u.getConfig("sortOrder"),h=u.getConfig("sortKey"),p=_.map(a,function(t){var n=["cell"];h===t.key&&(n.push("sorted"),n.push("order-"+c)),f%2===0&&n.push("even");var r=o.toJSON();return{key:t.key,type:t.type||"value",classNames:n.join(" "),value:e.getFormatted(r[t.key],t.formatter,r),align:t.align||"left",width:t.width?t.width+"px":"auto",renderHTML:t.renderHTML}}),d=new n({items:new i(p)}),m=s.createView({model:d,View:v,parentView:t,rowModel:o});r[m.cid]=m,m.$el.appendTo(l)},t.addHeaderItem=function(o){var f=u.getConfig("sortOrder"),l=u.getConfig("sortKey"),c=_.map(a,function(t){var n=["header-cell"];return t.sortable!==!1&&n.push("sortable"),l===t.key&&(n.push("sorted"),n.push("order-"+f)),{key:t.key,type:t.type||"value",classNames:n.join(" "),label:t.label||e.beautifyId(t.key),align:t.align||"left",width:t.width?t.width+"px":"auto"}}),h=new n({items:new i(c)}),p=s.createView({View:m,model:h,parentEl:o,parentView:t,rowCollection:u});r[p.cid]=p},t.removeItem=function(e){var n=t.getModelViewAt(e.id);n.remove()},t.removeAllRows=function(){_.each(r,function(e,t){e.remove()})},t.getModelViewAt=function(e){return r[e]},t.removeReferences(function(){t=null,r=null,o=null,u=null})},y=t.extend({template:'<div class="table-header"></div> <table class="row-list"></table><div class="table-footer"></div>',className:"data-table",events:{"click th.sortable":"toggleSort"},constructor:function(e){var n=this;t.call(n,e),_.each([g],function(t){t.call(n,e)});var r=this.getOption("rowCollection");n.listenTo(r,"config_change",n.loadRows),n.listenTo(r,"reset",function(){n.redrawTable()})},redrawTable:function(){this.removeAllRows(),this.renderHeader(),this.renderRows()},postRender:function(){this.loadRows()},loadRows:function(){var e=this,t=this.$el,n=this.getOption("rowCollection");t.hide();var r=n.getConfigs();if(r.requestId){var i=e.addRequest({id:r.requestId,params:r});i.done(function(e){n.setConfig("totalRecords",e.totalRecords),n.reset(e.results)})}else n.url?n.fetch({processData:!0,reset:!0}):e.redrawTable();t.show()},renderRows:function(){var e=this,t=e.getOption("rowCollection"),n=t.getProcessedRecords(),r=this.$(".row-list");n.length===0?e.renderNoData():_.each(n,function(t,n){e.addItem(t,n,r)})},renderNoData:function(){var t=this,n=this.getOption("noDataTemplate")||"No Records",r=this.$(".row-list"),i=this.getOption("columns");e.getTemplateDef(n,t.getTemplateType()).done(function(e){var t=$("<td></td>").prop("colspan",i.length);t.html(e({}));var n=$('<tr class="table-row no-data-row"></tr>').appendTo(r);t.appendTo(n)})},renderHeader:function(){var e=this,t=this.$(".row-list");e.addHeaderItem(t)},loadingHandler:function(e){t.prototype.loadingHandler.call(this,e)},toggleSort:function(e){var t=$(e.currentTarget),n=t.data("key");this.getOption("rowCollection").setSortKey(n)}});return{View:y,RowCollection:o,Model:a}});